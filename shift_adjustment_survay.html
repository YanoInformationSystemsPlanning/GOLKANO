<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>シフト調整ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      width: 100vw;
      height: 100vh;
      overflow: auto;
    }
    .header-bar {
      display: flex;
      align-items: center;
      gap: 1em;
      padding: 5px 10px;
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
    }
    .status {
      font-weight: bold;
      color: red;
    }
    select, button {
      padding: 2px 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .grid {
      display: grid;
      border: 1px solid #ccc;
      margin: 10px;
      overflow-x: auto;
    }
    .grid > div {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      font-size: 12px;
      white-space: nowrap;
    }
    .editable {
      background-color: #f9f9f9;
      cursor: pointer;
    }
    .selected {
      background-color: #ffeb3b;
    }
    .holiday {
      background-color: #e6f7ff;
    }
    #messageBox {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #333;
      color: white;
      padding: 10px;
      border-radius: 4px;
      display: none;
      z-index: 100;
    }
    #messageBox.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <span id="userNameDisplay"></span>
    <span id="targetDate"></span>
    <span id="loadingStatus" class="status"></span>
    <button id="exportBtn" style="display:none;">回答提出</button>
  </div>
  <div class="grid" id="grid"></div>
  <div id="version-label" style="text-align:left; margin:10px;">Ver.2 Rev.0</div>

  <div id="messageBox"></div>

  <!-- パスワードモーダル -->
  <div id="passwordModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:5px; max-width:300px; margin:auto;">
      <div id="passwordPrompt">パスワードを入力してください</div>
      <input type="password" id="passwordInput" style="width:100%; padding:5px; margin:10px 0;">
      <div id="passwordError" style="color:red; display:none;">パスワードが違います</div>
      <button id="passwordOkBtn">OK</button>
      <button id="passwordCancelBtn">キャンセル</button>
    </div>
  </div>

<script>
  const grid = document.getElementById("grid");
  const targetDateSpan = document.getElementById("targetDate");
  const loadingStatus = document.getElementById("loadingStatus");
  const exportBtn = document.getElementById("exportBtn");
  const messageBox = document.getElementById("messageBox");

  const passwordModal = document.getElementById("passwordModal");
  const passwordPrompt = document.getElementById("passwordPrompt");
  const passwordInput = document.getElementById("passwordInput");
  const passwordError = document.getElementById("passwordError");
  const passwordOkBtn = document.getElementById("passwordOkBtn");
  const passwordCancelBtn = document.getElementById("passwordCancelBtn");

  const gasUrl = "https://script.google.com/macros/s/AKfycbyecyW2BpBWp_-z2KuWq2lf-c4gXlJVeILV8SlqgA8b3Li79fiM7Dil7WSrTE4FHVS64w/exec";
  const folderKeyword = "shift_adjustment_survay";

  let allInputLines = [];
  let cellRefs = [];
  let year = '';
  let month = '';
  let highlightData = [];
  let currentPassword = '';
  let isNewFile = false;
  let passwordCallback = null;
  let savedPasswordForCheck = '';

  const userName = localStorage.getItem("userName") || "不明なユーザー";
  document.getElementById("userNameDisplay").textContent = `回答者：${userName}`;

  function showMessage(msg, type = 'info') {
    messageBox.className = `show ${type}`;
    messageBox.textContent = msg;
    setTimeout(() => messageBox.classList.remove('show'), 3000);
  }

  function parseCSVLine(line) {
    return line.split(',').map(s => s.trim());
  }

  function initAllData() {
    fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=input_data.txt`)
      .then(res => res.text())
      .then(text => {
        allInputLines = text.split('\n').filter(l => l.trim());
        const ym = parseCSVLine(allInputLines[0]);
        year = ym[1];
        month = ym[2];
        targetDateSpan.textContent = `対象：${year}年${month}月`;

        // ユーザー情報からデータ読み込み
        loadDataForUser();
      })
      .catch(err => showMessage("ヘッダ情報の読み込みに失敗しました。\n" + err.message, 'error'));
  }

  function loadDataForUser() {
    loadingStatus.textContent = "処理中...";
    const prefix = `${userName}_`;
    fetch(`${gasUrl}?action=list&folder=${folderKeyword}&prefix=${encodeURIComponent(prefix)}`)
      .then(res => res.json())
      .then(data => {
        if (data.result === "success" && data.files.length > 0) {
          isNewFile = false;
          const latest = data.files.sort((a, b) => b.localeCompare(a))[0];
          fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=${encodeURIComponent(latest)}`)
            .then(res => res.text())
            .then(outputText => {
              const outputLines = outputText.split('\n').filter(l => l.trim());
              const header = parseCSVLine(outputLines[0]);
              const savedPassword = header[2] || '';
              openPasswordModal("回答済です。内容の確認 or 修正にはパスワードを入力してください。", pw => {
                if (pw === null) { loadingStatus.textContent = ""; return; }
                currentPassword = savedPassword;
                const merged = mergeInputAndOutput(allInputLines, outputLines);
                loadGridFromData(merged);
                exportBtn.style.display = 'inline-block';
                loadingStatus.textContent = "";
              }, savedPassword);
            });
        } else {
          isNewFile = true;
          openPasswordModal("新規作成です。3桁のパスワードを入力してください。", pw => {
            if (pw === null) { loadingStatus.textContent = ""; return; }
            currentPassword = pw;
            const merged = [
              allInputLines[1],
              allInputLines[2],
              allInputLines[3],
              ...allInputLines.slice(4)
            ];
            loadGridFromData(merged);
            exportBtn.style.display = 'inline-block';
            loadingStatus.textContent = "";
          });
        }
      })
      .catch(err => {
        showMessage("ファイルチェックに失敗しました。\n" + err.message, 'error');
        loadingStatus.textContent = "";
      });
  }

  function mergeInputAndOutput(inputLines, outputLines) {
    const merged = [...inputLines];
    for (let i = 0; i < outputLines.length; i++) {
      if (i < merged.length) {
        merged[i] = outputLines[i];
      }
    }
    return merged;
  }

  function loadGridFromData(lines) {
    grid.innerHTML = '';
    cellRefs = [];
    lines.forEach((line, rowIndex) => {
      const cols = parseCSVLine(line);
      cols.forEach((col, colIndex) => {
        const cell = document.createElement('div');
        cell.textContent = col;
        if (rowIndex > 2 && colIndex > 0) {
          cell.classList.add('editable');
          cell.addEventListener('click', () => {
            cell.classList.toggle('selected');
          });
        }
        grid.appendChild(cell);
      });
    });
    grid.style.gridTemplateColumns = `repeat(${parseCSVLine(lines[0]).length}, auto)`;
  }

  exportBtn.addEventListener('click', () => {
    const updatedLines = [];
    const gridCells = Array.from(grid.children);
    const colCount = parseCSVLine(allInputLines[0]).length;
    for (let i = 0; i < gridCells.length; i += colCount) {
      const rowCells = gridCells.slice(i, i + colCount);
      const row = rowCells.map(c => (c.classList.contains('selected') ? '◯' : c.textContent)).join(',');
      updatedLines.push(row);
    }

    const fileName = `${userName}_${year}${month}.csv`;
    const content = [`header,${year},${month},${currentPassword}`, ...updatedLines].join('\n');

    fetch(`${gasUrl}?action=write&folder=${folderKeyword}&file=${encodeURIComponent(fileName)}`, {
      method: 'POST',
      body: content
    })
    .then(res => res.text())
    .then(msg => showMessage("回答を提出しました！"))
    .catch(err => showMessage("提出に失敗しました: " + err.message, 'error'));
  });

  function openPasswordModal(prompt, callback, savedPassword = '') {
    passwordPrompt.textContent = prompt;
    passwordInput.value = '';
    passwordError.style.display = 'none';
    passwordModal.style.display = 'flex';
    passwordInput.focus();
    savedPasswordForCheck = savedPassword;
    passwordCallback = callback;
  }

  passwordOkBtn.addEventListener('click', () => {
    const pw = passwordInput.value.trim();
    if (!pw) return;
    if (savedPasswordForCheck && pw !== savedPasswordForCheck) {
      passwordError.style.display = 'block';
      return;
    }
    passwordModal.style.display = 'none';
    passwordCallback(pw);
  });

  passwordCancelBtn.addEventListener('click', () => {
    passwordModal.style.display = 'none';
    passwordCallback(null);
  });

  window.onload = initAllData;
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const userName = localStorage.getItem("userName") || "不明なユーザー";
    const disp = document.getElementById("userNameDisplay");
    if (disp) disp.textContent = `回答者：${userName}`;
  });
</script>
</body>
</html>
