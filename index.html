<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Excel風スケジュール表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      width: 100vw;
      height: 100vh;
      overflow: auto;
    }
    .header-bar {
      display: flex;
      align-items: center;
      gap: 1em;
      padding: 5px 10px;
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
    }
    select {
      padding: 2px;
      font-size: 14px;
    }
    button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .grid {
      display: grid;
      grid-template-columns: 110px repeat(31, 36px);
      grid-auto-rows: 30px;
      min-width: max-content;
    }
    .cell {
      border: 1px solid #ccc;
      text-align: center;
      line-height: 30px;
      white-space: nowrap;
      user-select: none;
      background: white;
      position: relative;
      font-size: 14px;
      overflow: hidden;
    }
    .header-1 { position: sticky; top: 0; z-index: 5; background: #eee; }
    .header-2 { position: sticky; top: 30px; z-index: 5; background: #eee; }
    .header-3 { position: sticky; top: 60px; z-index: 5; background: #eee; }
    .fixed-col {
      position: sticky;
      left: 0;
      z-index: 4;
      background: #f8f8f8;
      padding-left: 2.5em;
    }
    .header-1.fixed-col,
    .header-2.fixed-col,
    .header-3.fixed-col { z-index: 6; }
    .highlight-black { background: black !important; color: white; }
    .highlight-gray { background: gray !important; color: white; }
    .red { color: red; }
  </style>
</head>
<body>
  <div class="header-bar">
    <span>回答者：</span>
    <select id="memberSelect"></select>
    <span id="targetDate"></span>
    <button id="exportBtn" style="display:none;">回答提出</button>
  </div>
  <div class="grid" id="grid"></div>

<script>
  const grid = document.getElementById("grid");
  const memberSelect = document.getElementById("memberSelect");
  const targetDateSpan = document.getElementById("targetDate");
  const exportBtn = document.getElementById("exportBtn");
  const gasUrl = "https://script.google.com/macros/s/AKfycbzCYQRN6hg9n8OERx11vJslBCvy0VmgO-nzMIryNO1gUD4Q1wim5srxDPCKsggYsMzf5g/exec";
  const folderId = "1P9IpgCw1L_cvKjemIpg3ygtOAOUePWZh";
  let cellRefs = [];
  let year = '';
  let month = '';
  let highlightData = [];

  function parseCSVLine(line) {
    return line.split(',').map(s => s.trim());
  }

  function loadHeaderOnly() {
    // プルダウンを input_data.txt の1行目から作成
    fetch(`${gasUrl}?action=read&folder=${folderId}&file=input_data.txt`)
      .then(res => res.text())
      .then(text => {
        const lines = text.split('\n').filter(l => l.trim());
        const memberLine = parseCSVLine(lines[0]);
        const members = memberLine.slice(1);
        memberSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
      })
      .catch(err => alert("ヘッダ情報の読み込みに失敗しました。\n" + err.message));
  }

  function loadGridFromData(lines) {
    grid.innerHTML = '';
    cellRefs = [];
    const data = lines.map(parseCSVLine);
    const rowCount = data.length;
    const colCount = 32;
    const fragment = document.createDocumentFragment();

    for (let r = 0; r < rowCount; r++) {
      const row = [];
      for (let c = 0; c < colCount; c++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        const val = data[r]?.[c] ?? '';
        if (c === 0) cell.classList.add("fixed-col");

        if (r === 0) {
          cell.classList.add("header-1");
          cell.textContent = c > 0 ? val : "日付";
        } else if (r === 1) {
          cell.classList.add("header-2");
          cell.innerHTML = c > 0 ? (['土','日'].includes(val) ? `<span class="red">${val}</span>` : val) : "曜日";
        } else if (r === 2) {
          cell.classList.add("header-3");
          if (c > 0) {
            cell.textContent = val;
            cell.onclick = () => {
              const states = ["●", "▲", ""];
              const idx = states.indexOf(cell.textContent);
              cell.textContent = states[(idx + 1) % 3];
            };
          } else {
            cell.textContent = "対応可能";
          }
        } else {
          cell.textContent = val;
          if (c > 0) {
            cell.onclick = () => {
              if (cell.classList.contains("highlight-black")) {
                cell.classList.remove("highlight-black");
                cell.classList.add("highlight-gray");
              } else if (cell.classList.contains("highlight-gray")) {
                cell.classList.remove("highlight-gray");
              } else {
                cell.classList.add("highlight-black");
              }
            };
          }
        }
        fragment.appendChild(cell);
        row.push(cell);
      }
      cellRefs.push(row);
    }
    grid.appendChild(fragment);
    applyHighlight();
  }

  function applyHighlight() {
    for (let r = 3; r < highlightData.length; r++) {
      const row = highlightData[r].split(',');
      for (let c = 1; c < row.length; c++) {
        if (row[c] === 'B') cellRefs[r][c].classList.add("highlight-black");
        else if (row[c] === 'G') cellRefs[r][c].classList.add("highlight-gray");
      }
    }
  }

  function mergeInputAndOutput(inputLines, outputLines) {
    const merged = [];
    highlightData = [...outputLines];

    // 1～3行目は output を採用
    merged[0] = outputLines[0] || '';
    merged[1] = outputLines[1] || '';
    merged[2] = outputLines[2] || '';

    // 年月情報
    const ym = parseCSVLine(outputLines[1]);
    year = ym[1];
    month = ym[2];
    targetDateSpan.textContent = `対象：${year}年${month}月`;

    // 4行目以降は input を採用
    for (let r = 3; r < inputLines.length; r++) {
      merged[r] = inputLines[r] || '';
    }

    return merged;
  }

  function loadDataForMember(member) {
    const prefix = `output_data_${member}_`;
    fetch(`${gasUrl}?action=list&folder=${folderId}&prefix=${encodeURIComponent(prefix)}`)
      .then(res => res.json())
      .then(data => {
        fetch(`${gasUrl}?action=read&folder=${folderId}&file=input_data.txt`)
          .then(res => res.text())
          .then(inputText => {
            const inputLines = inputText.split('\n').filter(l => l.trim());
            if (data.result === "success" && data.files.length > 0) {
              const latest = data.files.sort((a, b) => b.localeCompare(a))[0];
              fetch(`${gasUrl}?action=read&folder=${folderId}&file=${encodeURIComponent(latest)}`)
                .then(res => res.text())
                .then(outputText => {
                  const outputLines = outputText.split('\n').filter(l => l.trim());
                  const merged = mergeInputAndOutput(inputLines, outputLines);
                  loadGridFromData(merged);
                  exportBtn.style.display = 'inline-block';
                });
            } else {
              // output_dataがない場合は input_data.txt を使用
              const ym = parseCSVLine(inputLines[1]);
              year = ym[1];
              month = ym[2];
              targetDateSpan.textContent = `対象：${year}年${month}月`;
              loadGridFromData(inputLines);
              exportBtn.style.display = 'inline-block';
            }
          });
      })
      .catch(err => alert("ファイルチェックに失敗しました。\n" + err.message));
  }

  memberSelect.addEventListener('change', () => {
    loadDataForMember(memberSelect.value);
  });

  exportBtn.addEventListener('click', () => {
    let csv = `回答者,${memberSelect.value}\n年月,${year},${month}\n`;
    const rowCount = cellRefs.length;
    const colCount = 32;
    for (let r = 0; r < rowCount; r++) {
      const row = [];
      for (let c = 0; c < colCount; c++) {
        if (r < 3) {
          row.push(cellRefs[r][c].textContent);
        } else {
          if (cellRefs[r][c].classList.contains("highlight-black")) row.push('B');
          else if (cellRefs[r][c].classList.contains("highlight-gray")) row.push('G');
          else row.push('');
        }
      }
      csv += row.join(',') + '\n';
    }

    const member = memberSelect.value.replace(/ /g, '_');
    const targetYm = `${year}${month}`;
    const now = new Date();
    const yyyymmdd = now.getFullYear().toString() +
                     String(now.getMonth() + 1).padStart(2, '0') +
                     String(now.getDate()).padStart(2, '0');
    const hhmm = String(now.getHours()).padStart(2, '0') +
                 String(now.getMinutes()).padStart(2, '0');
    const filename = `output_data_${member}_${targetYm}_${yyyymmdd}_${hhmm}作成.txt`;

    fetch(`https://script.google.com/macros/s/AKfycbx3Ir7q8b82MhnlCqwQnmAAJp2IaHY2f0UwBezEQLXHpa_Zo4M8lx__gt2dbLbojTlSuw/exec?folder=${folderId}&filename=${encodeURIComponent(filename)}`, {
      method: 'POST',
      body: csv,
      headers: { 'Content-Type': 'text/plain' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === 'success') {
        alert(`Google Driveに保存しました！\nファイル名：${filename}`);
      } else {
        alert("保存エラー：" + data.message);
      }
    })
    .catch(err => {
      alert("通信エラー：" + err.message);
    });
  });

  window.onload = loadHeaderOnly;
</script>
</body>
</html>
