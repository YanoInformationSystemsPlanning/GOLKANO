<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>順位決め</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; text-align: center; margin: 1em; }
    #version-label { position: absolute; top: 0.2em; left: 0.2em; font-size: 0.8em; color: #555; }
    h2 { margin-bottom: 0.5em; }
    #purpose-area { margin-bottom: 0.5em; }
    #select-area {
      display: flex; flex-wrap: wrap; justify-content: center;
      gap: 8px; margin-bottom: 1.5em; min-height: 3em;
    }
    .select-btn {
      padding: 0.6em 1em; border-radius: 6px; border: 1px solid #888;
      background-color: white; font-size: 1em; max-width: 8em;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .select-btn.small-text { font-size: 0.85em; }
    .select-btn.selected { background-color: limegreen; color: white; }
    #rank-button {
      font-size: 1.2em; background-color: red; color: white;
      padding: 0.6em 1.5em; border: none; border-radius: 5px;
      cursor: pointer; margin-bottom: 0.5em;
    }
    #result-area { text-align: left; margin-left: 1.0em; display: inline-block; }
  </style>
</head>
<body>
  <div id="version-label">Ver.0 Rev.3</div>
  <div id="purpose-area">
    <label for="purpose-input"><strong>目的：</strong></label>
    <input id="purpose-input" type="text" maxlength="17"
           style="width: 17em; font-size: 1.0em;" placeholder="例：コース mm/dd キャンセル調整">
  </div>

  <h2>候補者一覧</h2>
  <div id="select-area">読み込み中...</div>
  <button id="rank-button" onclick="generateRanking()">順位決め</button>
  <div style="width: 100%;"></div>
  <div id="result-area" style="margin-top: 0;"></div>

  <script>
    let CANDIDATES = [];

    // Google Apps Script 経由で候補者リストを取得
    async function fetchCandidates() {
      const folderId = "1vY3sgy2XT6vSun_gq1O47EuOikCEeCOe"; // DriveフォルダID
      const fileName = "input_data.txt";                     // 読み込むファイル名
      const url = `https://script.google.com/macros/s/AKfycbzCYQRN6hg9n8OERx11vJslBCvy0VmgO-nzMIryNO1gUD4Q1wim5srxDPCKsggYsMzf5g/exec?action=read&folder=${folderId}&file=${fileName}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTPエラー ${response.status}`);
        const text = await response.text();
        CANDIDATES = text.split(/\r?\n/).map(name => name.trim()).filter(name => name);
        renderCandidates();
      } catch (e) {
        document.getElementById('select-area').innerHTML = `<span style="color:red;">データ取得エラー: ${e}</span>`;
      }
    }

    function renderCandidates() {
      const area = document.getElementById("select-area");
      area.innerHTML = '';
      CANDIDATES.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.className = "select-btn";
        if (name.length > 4) btn.classList.add("small-text");
        btn.onclick = () => btn.classList.toggle("selected");
        area.appendChild(btn);
      });
    }

    function generateRanking() {
      const selected = Array.from(document.getElementsByClassName("select-btn"))
        .filter(btn => btn.classList.contains("selected"))
        .map(btn => btn.textContent);

      const ordered = CANDIDATES.filter(name => selected.includes(name));
      const shuffled = shuffle([...ordered]);
      const purpose = document.getElementById("purpose-input").value.trim();
      const resultArea = document.getElementById("result-area");
      resultArea.innerHTML = "";

      if (purpose) resultArea.innerHTML += `<div style="margin-bottom:0.5em;"><strong>目的：</strong>${purpose}</div>`;
      resultArea.innerHTML += `<h3 style="margin-bottom: 0.2em;">結果一覧</h3>`;
      shuffled.forEach((name, index) => {
        resultArea.innerHTML += `<div>${index + 1}位：${name}</div>`;
      });

      const now = new Date();
      const formatted = `${now.getFullYear()}年${String(now.getMonth()+1).padStart(2,'0')}月${String(now.getDate()).padStart(2,'0')}日 ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      resultArea.innerHTML += `<div style="margin-top:0.5em; font-size:1em;">実施：${formatted}</div>`;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const r = Math.floor(Math.random() * (i + 1));
        [array[i], array[r]] = [array[r], array[i]];
      }
      return array;
    }

    fetchCandidates();
  </script>
</body>
</html>
